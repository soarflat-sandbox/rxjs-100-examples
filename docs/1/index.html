<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>1</title>
</head>

<body>
  <p>open console!!</p>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/5.5.10/Rx.min.js"></script>
  <script>
    const Observable = Rx.Observable;

    // 9割の確率でtrueを返す。
    function isSuccess() {
      return Math.random() > 0.1;
    }

    // 非同期処理。1割の確率で失敗する。成功すると文字を大文字にして返す。
    // 成功のときはObservable.of(value)を返すが、失敗のときはObservable.emptyを返す。
    function httpRequest(value) {
      const promise = new Promise((resolve, reject) => {
        if (isSuccess()) {
          resolve(value.toUpperCase());
        } else {
          reject();
        }
      });

      // PromiseをObservableに変換する。
      // resolveのときはObservable.ofを返し、rejectのときはObservable.emptyを返す。
      return Observable
        .from(promise)
        .catch(_ => Observable.empty());
    }

    // 複数の非同期処理をまとめた配列を返す。
    function requests() {
      return [
        httpRequest('h'),
        httpRequest('e'),
        httpRequest('l'),
        httpRequest('l'),
        httpRequest('o'),
      ]
    }

    for (let i = 0; i < 10; i++) {
      Observable
        .forkJoin(requests())
        .map(array => array.join(''))
        .defaultIfEmpty('(empty)')
        .zip(Observable.of(i))
        .map(([value, index]) => `${index}: ${value}`)
        .subscribe(console.log);
    }
  </script>
</body>

</html>
